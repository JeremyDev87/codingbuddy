name: codingbuddy-canary

on:
  push:
    branches:
      - master
      - stag-**
    paths:
      - 'apps/mcp-server/**'
      - 'packages/rules/**'
      - '.antigravity/**'
      - '.claude/**'
      - '.codex/**'
      - '.cursor/**'
      - 'scripts/**'
      - .github/workflows/canary.yml

permissions:
  statuses: write
  contents: read

jobs:
  publish-canary:
    if: github.repository == 'JeremyDev87/codingbuddy'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build mcp-server
        run: yarn workspace codingbuddy build

      # Generate a single canary version to ensure both packages use the same version
      # This fixes the timestamp mismatch bug where rules and mcp-server had different versions
      - name: Generate canary version
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          COMMIT_SHA=${GITHUB_SHA::7}
          VERSION="0.0.0-canary.${TIMESTAMP}.${COMMIT_SHA}"
          if [ -z "$VERSION" ]; then
            echo "::error::Failed to generate canary version"
            exit 1
          fi
          echo "CANARY_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Generated canary version: $VERSION"

      - name: Publish rules canary
        working-directory: packages/rules
        run: |
          VERSION="${{ env.CANARY_VERSION }}"
          cat <<< "$( jq --arg v "$VERSION" '.version = $v' package.json )" > package.json
          yarn npm publish --tag canary
        env:
          YARN_NPM_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish mcp-server canary
        working-directory: apps/mcp-server
        run: |
          VERSION="${{ env.CANARY_VERSION }}"
          # Update version and replace workspace dependency with canary version
          cat <<< "$( jq --arg v "$VERSION" '.version = $v | .dependencies["codingbuddy-rules"] = $v' package.json )" > package.json
          yarn npm publish --tag canary
        env:
          YARN_NPM_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Output canary version number
        working-directory: apps/mcp-server
        run: |
          name=$(jq -r .name package.json)
          version=$(jq -r .version package.json)
          yarn dlx action-status --context "Published $name" --state success --description $version --url "https://unpkg.com/$name@$version/"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
